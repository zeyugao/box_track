<!DOCTYPE HTML>
<html>

<head>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script>
        window.chartColors = {
            red: 'rgb(255, 99, 132)',
            orange: 'rgb(255, 159, 64)',
            yellow: 'rgb(255, 205, 86)',
            green: 'rgb(75, 192, 192)',
            blue: 'rgb(54, 162, 235)',
            purple: 'rgb(153, 102, 255)',
            grey: 'rgb(201, 203, 207)'
        };
        var default_data = {
            labels: [],
            datasets: []
        }
        var config = {
            type: 'line',
            data: JSON.parse(JSON.stringify(default_data)),
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: 'Box in Japan'
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    x: {
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'DateTime'
                        }
                    },
                    y: {
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Sale'
                        }
                    }
                }
            }
        };
        var colorNames = Object.keys(window.chartColors);
        var update_chart = function (names) {
            document.getElementById('refresh').innerText = "Loading";
            axios.post("/api/japan_box", { name: names })
                .then(function (resp) {
                    var color_count = 0;
                    var new_datasets = {};
                    names.forEach(function (item, index) {
                        var new_color = window.chartColors[colorNames[color_count % colorNames.length]];
                        new_datasets[item] = {
                            label: item,
                            backgroundColor: new_color,
                            borderColor: new_color,
                            data: [],
                            fill: false,
                            lineTension: 0,
                        };
                        color_count++;
                    })
                    var box = resp.data.data[0];
                    config.data = JSON.parse(JSON.stringify(default_data));
                    for (var key in box) {
                        config.data.labels.push(key);
                        var movies_detail = box[key];
                        box[key].forEach(movie => new_datasets[movie.name].data.push(movie.sale));
                    }

                    for (var key in new_datasets) {
                        config.data.datasets.push(new_datasets[key]);
                    }
                    window.chart.update();
                    document.getElementById('refresh').innerText = "Refresh";
                })
        };
        var update_chart_wrapper = function () {
            update_chart(["アナと雪の女王２", "スター・ウォーズ スカイウォ…"]);
        }
        window.onload = function () {
            var ctx = document.getElementById('canvas').getContext('2d');
            window.chart = new Chart(ctx, config);
            update_chart_wrapper();
            document.getElementById('refresh').addEventListener('click', update_chart_wrapper);
        };
    </script>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div style="width:90%;">
                <canvas id="canvas"></canvas>
            </div>
        </div>
        <div class="row justify-content-end">
            <button class="btn btn-primary" type="button" id="refresh">Refresh</button>
        </div>
    </div>
</body>

</html>